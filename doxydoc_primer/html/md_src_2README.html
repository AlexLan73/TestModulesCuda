<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Test moduls: Тестовые скрипты</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Test moduls
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Тестовые скрипты</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md0"></a> Тестовые скрипты (<code>model-checker.sh</code>, <code>test-patches.sh</code>) сделаны для проверок рефакторинга кода (т.е. преобразований, улучшающих структуру и/или быстродействие кода, но не меняющих его поведение), хотя могут использоваться и для обнаружения нежелательных последствий любых изменений (например, если доработка касается только МРИК, но внезапно меняется выдача модели для СМ). В основе работы скриптов лежит простая идея - мы сохраняем выдачу (все срезы) прогона некого ФУ на "заведомо правильной" базовой версии модели, и затем сравниваем сохраненную выдачу с выдачей новой версии модели. Очевидно, что для тщательной проверки необходимо много разнообразного ФУ (которое затрагивает все режимы работы модели); имеющееся тестовое ФУ хранится в поддереве каталогов с корнем в <code>src/model/testcases</code>. В свою очередь, ФУ разделяется по станциям - ФУ каждой станции хранится в подкаталогах <code>testcases/MRIK</code>, <code>testcases/VoronezhM</code>, <code>testcases/VoronezhCM</code>, с легкими для понимания мнемоническими именами вроде <code>1fu_M_strobe_1_tipsig_1_object_8_type_interf</code>. Подкаталог с ФУ содержит собственно файл или файлы с ФУ (несколько файлов с сообщениями ФУ, зарегистрированными через ФПО МПК1, или файл <code>input.json</code>, импортированный из GUI модели - см. ниже); выдача от прогона ФУ так же сохраняется в каталоге ФУ (точнее, в подкаталоге <code>baselines</code> каталога ФУ). Возможно сохранять выдачу разных вариантов модели под разными именами - т.е. фактически создавать <em>несколько именованых эталонов</em> (baseline-ов; термины "эталон" и "baseline" будут использоваться как эквивалентные): это бывает полезным, например, при отработке одной версии модели в разных системах - например, выдачу от прогона модели в Debian 9 сохранять под именем <code>debian9</code> (в <code>baselines/debian9</code>), а выдачу от прогона в Ubuntu 16.04 - под именем <code>ubuntu16</code> (в <code>baselines/ubuntu16</code>). Имя эталона задается через опцию <code>-n</code>, ее можно использовать и при сохранении выдачи, и при сравнении текущей выдачи с сохраненной; впрочем, имя эталона задавать не обязательно (если оно не задано, считается, что это имя - <code>default</code>, и данные от прогона ФУ сохраняются в подкаталоге <code>baselines/default</code>);</p>
<p>Для сохранения выдачи предназначена команда <code>./model-checker.sh make-baseline</code>; она принимает в виде аргумента список ФУ (т.е. имена каталогов с ФУ); например, команда </p><div class="fragment"><div class="line">./model-checker.sh make-baseline testcases/VoronezhM/1fu_M_strobe_1_tipsig_1_object_8_type_interf</div>
</div><!-- fragment --><p> сохранит выдачу, сгенерированную прогоном ФУ из каталога <code>testcases/VoronezhM/1fu_M_strobe_1_tipsig_1_object_8_type_interf</code> на текущем варианте модели.</p>
<p>Команда </p><div class="fragment"><div class="line">./model-checker.sh make-baseline testcases/*/*</div>
</div><!-- fragment --><p> сохранит выдачу всех имеющихся ФУ (в обоих случаях, выдача будет сохранена под именем <code>default</code>).</p>
<p><b>Tip 1</b>: если у вас не хватает места, вы можете создавать эталоны где угодно - скопируйте <code>testcases</code> в другой каталог и укажите файлы из этого каталога в вызове <code>model-checker.sh</code> </p><div class="fragment"><div class="line">cp -rs $(pwd)/testcases /media/me/ext_hdd</div>
<div class="line">./model-checker.sh make-baseline /media/me/ext_hdd/testcases/*/*</div>
<div class="line">./model-checker.sh check-baseline /media/me/ext_hdd/testcases/*/*</div>
</div><!-- fragment --><p> Весь огромный объем данных эталонов будет записан в подкаталоги <code>/media/me/ext_hdd</code>. Заметьте, что используется команда <code>cp -rs</code>, которая вместо настоящего копирования делает симлинки на оригинальные файлы (но создает реальное дерево каталогов); <code>cp -rs</code> необходимы 2 абсолютных имени, поэтому <code>$(pwd)/testcases</code> делает из <code>testcases</code> абсолютное имя. Вместо <code>cp -rs</code> можно использовать и обычную <code>cp -r testcases /media/me/ext_hdd</code>, но тогдна файлы с ФУ будут скопированы, и их правки придется вручную переносить в рабочую копию.</p>
<p>Для сравнения выдачи текущего варианта модели с сохраненным используется команда <code>./model-checker.sh check-baseline</code>; например, команда </p><div class="fragment"><div class="line">./model-checker.sh check-baseline testcases/*/*</div>
</div><!-- fragment --><p> сравнит выдачу всех имеющихся ФУ с ранее сохраненной (под именем <code>default</code>).</p>
<p><b>Tip 2</b>: при проверке эталона во временный каталог записывается содержимое всех срезов, генерируются MD5-суммы всех записанных файлов, затем полученные MD5-суммы сравниваются с MD5-суммами файлов эталона. Если у вас есть (даже сравнительно небольшой - 20-30GB) быстрый носитель (SSD), можно создавать временный каталог там, это заметно ускоряет работу: </p><div class="fragment"><div class="line">./model-checker.sh check-baseline -t /path/to/ssd testcases/*/*</div>
</div><!-- fragment --><p><b>Tip 3</b>: если у вас вообще нет места на диске, вы можете просто затарить файлы MD5-сумм существующих эталонов, растарить их куда сами захотите, и использовать получившийся "эталон": </p><div class="fragment"><div class="line">cd /media/me/ext_hdd</div>
<div class="line"># в текущем каталоге есть каталог testcases, содержащий один или несколько эталонов</div>
<div class="line">tar cvf /tmp/baselines.tar $(find testcases -name MD5SUMS)</div>
<div class="line">cd /tmp</div>
<div class="line">tar xvf baselines.tar</div>
<div class="line">cd ~/work/model/src</div>
<div class="line">./model_dumper /tmp/testcases/VoronezhCM/example</div>
</div><!-- fragment --><p>Команда </p><div class="fragment"><div class="line">./model-checker.sh check-baseline -n mybaseline testcases/*/*</div>
</div><!-- fragment --><p> сравнит выдачу всех имеющихся ФУ с ранее сохраненной под именем <code>mybaseline</code>. Обратите внимание, что в вызове обеих команд указываются имена каталогов с ФУ и (не обязательно) имена эталонов (baseline-ов); это значит, что вы можете проверять эталон для подмножества ФУ, указанного при его генерации.</p>
<p>Скрипты имеют много полезных опций и выдают подсказку по использованию при вызове без параметров.</p>
<p>Если в работе используются очереди патчей (расширение Mercurial <code>mq</code>), для проверки нескольких патчей одной командой можно использовать скрипт <code>test-patches.sh</code>. Он последовательно накладывает указанные патчи и сравнивает выдачу модели с указанным эталоном.</p>
<h2><a class="anchor" id="autotoc_md1"></a>
TL;DR</h2>
<p>На свежесобранной модели:</p>
<blockquote class="doxtable">
<p>&zwj;<code>cd src/model</code><br  />
 <code>./model-checker.sh make-baseline testcases/*/example</code> </p>
</blockquote>
<p>*...вносим изменения и собираем измененную модель...*</p>
<blockquote class="doxtable">
<p>&zwj;<code>./model-checker.sh check-baseline testcases/*/example</code> </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md2"></a>
Использование ФУ, сохраненного через GUI</h2>
<p>Для использования в тестах ФУ, сохраненного через GUI модели, его нужно импортировать, т.е. записать в поддерево <code>testcases</code>, соответствующее станции, для которой это ФУ предназначено. Импорт необходим по двум причинам: во-первых, ФУ, сохраняемое через GUI модели, не является валидным JSON (у некоторых объектов есть поля с одинаковыми именами), и просто неудобен для загрузки (например, все поля имеют строковые значения); во-вторых, тестовые скрипты рассчитывают на определенную структуру каталогов, и ее нужно создать (что делается при импорте). Импорт выполняется скриптом <code>testcases/import.sh</code>; он должен вызываться в каталоге, соответствующем станции (например, <code>testcases/VoronezhCM</code>). Предположим, что файлы с новым ФУ (<code>*.json</code>) для Воронеж-СМ находятся в каталоге <code>src/model/testcases</code>; тогда для их импорта нужно выдать команды: </p><div class="fragment"><div class="line">cd testcases/VoronezhCM</div>
<div class="line">../import.sh ../../*.json</div>
</div><!-- fragment --><p> Эта команда создаст в каталоге <code>testcases/VoronezhCM</code> каталоги, соответствующие именам файлов ФУ (без суффикса <code>.json</code>) или выдаст ошибку.</p>
<p>Собственно преобразование ФУ в валидный JSON делается скриптом <code><a class="el" href="convert__to__json_8py.html">convert_to_json.py</a></code>, например, так:</p>
<p><code>./convert_to_json.py</code> <em>имя-файла-с-ФУ</em></p>
<p><code>./convert_to_json.py</code> обрабатывает 1 файл (или, если аргумент не указан, стандартный вход) и выдает результат на стандартный вывод. Пользоваться этим скриптом следует только тогда, когда что-то пошло не так с <code>testcases/import.sh</code>.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
OpenMP</h1>
<p>Распараллеливание вычислений в модели сделано с использованием OpenMP, так что доступны все возможности OpenMP по настройке производительности (см. например, <a href="https://community.ibm.com/community/user/power/blogs/archive-user/2017/03/13/use-openmp-environment-variables-to-get-the-best-performance">здесь</a>); пока что эксперименты показывают, что единственным параметром, настройка которого дает (небольшой) выигрыш в скорости, является <code>OMP_WAIT_POLICY</code>: </p><div class="fragment"><div class="line">export OMP_WAIT_POLICY=passive</div>
<div class="line">./runLocalVersion</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
